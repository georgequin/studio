/**
 * @fileoverview Firestore Security Rules for the application.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for draft reports,
 * allows public read access to sources, categories, and departments,
 * and provides owner-only write access to finalized reports.
 *
 * Data Structure:
 * - /users/{userId}/draft_reports/{reportId}:  Draft reports owned by a specific user.
 * - /reports/{reportId}: Finalized reports.
 * - /sources/{sourceId}: News sources.
 * - /categories/{categoryId}: Report categories.
 * - /departments/{departmentId}: NHRC departments.
 *
 * Key Security Decisions:
 * - Users can only list their own draft reports.
 * - Sources, categories, and departments are publicly readable.
 * - The rules do NOT enforce the exact schema, focusing on authorization.
 * - Finalized reports lack specific authorization so it is set to owner-only.
 * - Finalized reports do not have an owner, so the rule defaults to false with a TODO.
 *
 * Denormalization for Authorization:
 * - The draft reports' data model uses path-based ownership (/users/{userId}/draft_reports/{reportId}) to avoid costly `get()` calls.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows access to a user's draft reports.
     * @path /users/{userId}/draft_reports/{reportId}
     * @allow (create) User 'aJuYSdn5M9ajQs8yBA4Wwi6MHGN2' can create a draft report under /users/aJuYSdn5M9ajQs8yBA4Wwi6MHGN2/draft_reports/report123.
     * @deny (create) User ' অন্যID ' cannot create a draft report under /users/aJuYSdn5M9ajQs8yBA4Wwi6MHGN2/draft_reports/report123.
     * @allow (get) User 'aJuYSdn5M9ajQs8yBA4Wwi6MHGN2' can get their draft report /users/aJuYSdn5M9ajQs8yBA4Wwi6MHGN2/draft_reports/report123.
     * @deny (get) User ' অন্যID ' cannot get the draft report /users/aJuYSdn5M9ajQs8yBA4Wwi6MHGN2/draft_reports/report123.
     * @allow (update) User 'aJuYSdn5M9ajQs8yBA4Wwi6MHGN2' can update their draft report /users/aJuYSdn5M9ajQs8yBA4Wwi6MHGN2/draft_reports/report123.
     * @deny (update) User ' অন্যID ' cannot update the draft report /users/aJuYSdn5M9ajQs8yBA4Wwi6MHGN2/draft_reports/report123.
     * @allow (delete) User 'aJuYSdn5M9ajQs8yBA4Wwi6MHGN2' can delete their draft report /users/aJuYSdn5M9ajQs8yBA4Wwi6MHGN2/draft_reports/report123.
     * @deny (delete) User ' অন্যID ' cannot delete the draft report /users/aJuYSdn5M9ajQs8yBA4Wwi6MHGN2/draft_reports/report123.
     * @principle Enforces document ownership for writes and restricts access to a user's own data tree.
     */
    match /users/{userId}/draft_reports/{reportId} {
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.id == userId;
      allow get: if isSignedIn() && isOwner(userId);
      allow list: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isOwner(userId) && resource.data.id == userId;
      allow delete: if isSignedIn() && isExistingOwner(userId);
    }

    /**
     * @description Allows public read access to sources and restricts write access.
     * @path /sources/{sourceId}
     * @allow (get) Any user can read a source.
     * @allow (list) Any user can list sources.
     * @deny (create) No user can create a source through client.
     * @deny (update) No user can update a source through client.
     * @deny (delete) No user can delete a source through client.
     * @principle Allows public read access with no write access.
     */
    match /sources/{sourceId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows public read access to categories and restricts write access.
     * @path /categories/{categoryId}
     * @allow (get) Any user can read a category.
     * @allow (list) Any user can list categories.
     * @deny (create) No user can create a category through client.
     * @deny (update) No user can update a category through client.
     * @deny (delete) No user can delete a category through client.
     * @principle Allows public read access with no write access.
     */
    match /categories/{categoryId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows public read access to departments and restricts write access.
     * @path /departments/{departmentId}
     * @allow (get) Any user can read a department.
     * @allow (list) Any user can list departments.
     * @deny (create) No user can create a department through client.
     * @deny (update) No user can update a department through client.
     * @deny (delete) No user can delete a department through client.
     * @principle Allows public read access with no write access.
     */
    match /departments/{departmentId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows owner-only access to reports.
     * @path /reports/{reportId}
     */
    match /reports/{reportId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }
  }

  function isSignedIn() {
    return request.auth != null;
  }

  function isOwner(userId) {
    return request.auth.uid == userId;
  }

  function isExistingOwner(userId) {
    return isOwner(userId) && resource != null;
  }
}