/**
 * @file Firestore Security Rules
 * @description This ruleset enforces a strict user-ownership model for draft reports,
 *              while allowing public read access to sources, categories, and departments.
 *              The finalized reports collection is currently open for read, but
 *              guidelines are provided for securing it if necessary.
 *
 * @dataStructure
 *  /users/{userId}/draft_reports/{reportId}: Stores draft reports, editable only by the owning user.
 *  /reports/{reportId}: Stores finalized reports. Currently publicly readable, but can be secured with a members map.
 *  /sources/{sourceId}: Stores news sources. Publicly readable.
 *  /categories/{categoryId}: Stores report categories. Publicly readable.
 *  /departments/{departmentId}: Stores departments. Publicly readable.
 *
 * @keySecurityDecisions
 *  - User draft reports are strictly owned by the user ID in the path.
 *  - Listing of user draft reports is allowed only for the owner.
 *  - Sources, categories, and departments are publicly readable.
 *  - Finalized reports are publicly readable for now, with notes on how to restrict.
 *  - No schema validation is performed beyond ownership checks in this prototyping phase.
 *
 * @denormalizationForAuthorization
 *  - Path-based ownership for draft reports eliminates the need for `get()` calls to verify ownership.
 *
 * @structuralSegregation
 *  - Draft reports are stored in a private user subcollection, while finalized reports are in a public top-level collection.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows the owner to manage their draft reports.
     * @path /users/{userId}/draft_reports/{reportId}
     * @allow (create) User 'aJuYSdn5M9ajQs8yBA4Wwi6MHGN2' can create a draft report under /users/aJuYSdn5M9ajQs8yBA4Wwi6MHGN2/draft_reports/report1.
     * @allow (get) User 'aJuYSdn5M9ajQs8yBA4Wwi6MHGN2' can get a draft report under /users/aJuYSdn5M9ajQs8yBA4Wwi6MHGN2/draft_reports/report1.
     * @allow (update) User 'aJuYSdn5M9ajQs8yBA4Wwi6MHGN2' can update a draft report under /users/aJuYSdn5M9ajQs8yBA4Wwi6MHGN2/draft_reports/report1.
     * @allow (delete) User 'aJuYSdn5M9ajQs8yBA4Wwi6MHGN2' can delete a draft report under /users/aJuYSdn5M9ajQs8yBA4Wwi6MHGN2/draft_reports/report1.
     * @deny (create) User 'attackerId' cannot create a draft report under /users/aJuYSdn5M9ajQs8yBA4Wwi6MHGN2/draft_reports/report1.
     * @deny (get) User 'attackerId' cannot get a draft report under /users/aJuYSdn5M9ajQs8yBA4Wwi6MHGN2/draft_reports/report1.
     * @deny (update) User 'attackerId' cannot update a draft report under /users/aJuYSdn5M9ajQs8yBA4Wwi6MHGN2/draft_reports/report1.
     * @deny (delete) User 'attackerId' cannot delete a draft report under /users/aJuYSdn5M9ajQs8yBA4Wwi6MHGN2/draft_reports/report1.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/draft_reports/{reportId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Allows public read access to reports, but consider restricting write access with a members map.
     * @path /reports/{reportId}
     * @allow (get) Any user can get a report.
     * @allow (list) Any user can list reports.
     * @deny (create) No user can create a report without specific authorization.
     * @deny (update) No user can update a report without specific authorization.
     * @deny (delete) No user can delete a report without specific authorization.
     * @principle Allows public read access while restricting write access.
     */
    match /reports/{reportId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows public read access to sources.
     * @path /sources/{sourceId}
     * @allow (get) Any user can get a source.
     * @allow (list) Any user can list sources.
     * @deny (create) No user can create a source without specific authorization.
     * @deny (update) No user can update a source without specific authorization.
     * @deny (delete) No user can delete a source without specific authorization.
     * @principle Allows public read access while restricting write access.
     */
    match /sources/{sourceId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows public read access to categories.
     * @path /categories/{categoryId}
     * @allow (get) Any user can get a category.
     * @allow (list) Any user can list categories.
     * @deny (create) No user can create a category without specific authorization.
     * @deny (update) No user can update a category without specific authorization.
     * @deny (delete) No user can delete a category without specific authorization.
     * @principle Allows public read access while restricting write access.
     */
    match /categories/{categoryId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows public read access to departments.
     * @path /departments/{departmentId}
     * @allow (get) Any user can get a department.
     * @allow (list) Any user can list departments.
     * @deny (create) No user can create a department without specific authorization.
     * @deny (update) No user can update a department without specific authorization.
     * @deny (delete) No user can delete a department without specific authorization.
     * @principle Allows public read access while restricting write access.
     */
    match /departments/{departmentId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }
  }

  // Helper functions
  function isSignedIn() {
    return request.auth != null;
  }

  function isOwner(userId) {
    return isSignedIn() && request.auth.uid == userId;
  }

  function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
  }
}