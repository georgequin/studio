/**
 * @file Firestore Security Rules
 * @description This ruleset enforces a strict user-ownership model for draft reports,
 *              allows public read access to sources, categories, and departments, and
 *              restricts write access to sources.
 *
 * Data Structure:
 * - /users/{userId}/draft_reports/{reportId}: Draft reports, owned by individual users.
 * - /reports/{reportId}: Finalized reports (access control TBD, currently open).
 * - /sources/{sourceId}: News sources. Publicly readable, but writes are denied without authentication.
 * - /categories/{categoryId}: Report categories. Publicly readable, but writes are denied.
 * - /departments/{departmentId}: NHRC departments. Publicly readable, but writes are denied.
 *
 * Key Security Decisions:
 * - Users can only read and write their own draft reports.
 * - Listing reports is only allowed for draft reports within a user's collection.
 * - Sources, categories, and departments are publicly readable.
 * - Writes to the `sources` collection are denied (seeding must be done via backend).
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows users to manage their own draft reports.
     * @path /users/{userId}/draft_reports/{reportId}
     * @allow (create) User A creates a new draft report under their own user ID.
     *          auth.uid == "userA" and request.resource.data.id == "userA"
     * @allow (get) User A retrieves a draft report with ID "report1" under their user ID.
     *          auth.uid == "userA"
     * @allow (update) User A updates a draft report with ID "report1" under their user ID.
     *          auth.uid == "userA"
     * @allow (delete) User A deletes a draft report with ID "report1" under their user ID.
     *          auth.uid == "userA"
     * @deny (create) User A attempts to create a draft report under User B's user ID.
     *          auth.uid == "userA" and request.resource.data.id == "userB"
     * @deny (get) User A attempts to retrieve a draft report under User B's user ID.
     *          auth.uid == "userB"
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/draft_reports/{reportId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function isOwner(userId) {
        return request.auth.uid == userId;
      }
      function isExistingOwner(userId) {
        return isOwner(userId) && resource.data != null;
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isExistingOwner(userId);
      allow delete: if isSignedIn() && isExistingOwner(userId);
    }

    /**
     * @description Allows anyone to read finalized reports, but restricts writes.
     * @path /reports/{reportId}
     * @allow (get) Any user can retrieve a report.
     *          auth.uid == null
     * @allow (list) Any user can list reports.
     *          auth.uid == null
     * @deny (create) Any user attempts to create a report.
     *          auth.uid == "userA"
     * @deny (update) Any user attempts to update a report.
     *          auth.uid == "userA"
     * @deny (delete) Any user attempts to delete a report.
     *          auth.uid == "userA"
     * @principle Restricts write access to finalized reports.
     */
    match /reports/{reportId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows public read access to news sources, but restricts writes.
     * @path /sources/{sourceId}
     * @allow (get) Any user can retrieve a news source.
     *          auth.uid == null
     * @allow (list) Any user can list news sources.
     *          auth.uid == null
     * @deny (create) Any user attempts to create a news source.
     *          auth.uid == "userA"
     * @deny (update) Any user attempts to update a news source.
     *          auth.uid == "userA"
     * @deny (delete) Any user attempts to delete a news source.
     *          auth.uid == "userA"
     * @principle Restricts write access to news sources.
     */
    match /sources/{sourceId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows public read access to report categories, but restricts writes.
     * @path /categories/{categoryId}
     * @allow (get) Any user can retrieve a category.
     *          auth.uid == null
     * @allow (list) Any user can list categories.
     *          auth.uid == null
     * @deny (create) Any user attempts to create a category.
     *          auth.uid == "userA"
     * @deny (update) Any user attempts to update a category.
     *          auth.uid == "userA"
     * @deny (delete) Any user attempts to delete a category.
     *          auth.uid == "userA"
     * @principle Restricts write access to report categories.
     */
    match /categories/{categoryId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows public read access to NHRC departments, but restricts writes.
     * @path /departments/{departmentId}
     * @allow (get) Any user can retrieve a department.
     *          auth.uid == null
     * @allow (list) Any user can list departments.
     *          auth.uid == null
     * @deny (create) Any user attempts to create a department.
     *          auth.uid == "userA"
     * @deny (update) Any user attempts to update a department.
     *          auth.uid == "userA"
     * @deny (delete) Any user attempts to delete a department.
     *          auth.uid == "userA"
     * @principle Restricts write access to NHRC departments.
     */
    match /departments/{departmentId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }
  }
}