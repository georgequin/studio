/**
 * @file Firestore Security Rules
 * @description This ruleset enforces a strict user-ownership model for draft reports,
 *              allows public read access to sources, categories, and departments,
 *              and requires backend-controlled transitions for finalized reports.
 *
 * Data Structure:
 * - /users/{userId}/draft_reports/{reportId}: Stores draft reports, only accessible by the owning user.
 * - /reports/{reportId}: Stores finalized reports. Currently allows public read, but consider adding a members map for access control.
 * - /sources/{sourceId}: Stores news sources. Publicly readable.
 * - /categories/{categoryId}: Stores report categories. Publicly readable.
 * - /departments/{departmentId}: Stores NHRC departments. Publicly readable.
 *
 * Key Security Decisions:
 * - User-owned draft reports: Enforces path-based ownership, eliminating the need for additional reads.
 * - Public read access for sources, categories, and departments: Assumes no sensitive information is stored in these collections.
 * - Backend-controlled transitions: Requires a backend function to handle moving reports from draft to finalized, ensuring secure access control during the transition.
 * - The ruleset DOES NOT enforce a schema.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows the owner to read, create, update, and delete their own draft reports.
     * @path /users/{userId}/draft_reports/{reportId}
     * @allow (create) User with UID "user123" can create a new draft report under /users/user123/draft_reports/report456.
     * @allow (get, list, update, delete) User with UID "user123" can read, update, and delete their draft report /users/user123/draft_reports/report456.
     * @deny (create) User with UID "user456" cannot create a draft report under /users/user123/draft_reports/report789.
     * @deny (get, list, update, delete) User with UID "user456" cannot read, update, or delete the draft report /users/user123/draft_reports/report456.
     * @principle Enforces document ownership for writes, restricts access to a user's own data tree.
     */
    match /users/{userId}/draft_reports/{reportId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.id == reportId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Allows anyone to read finalized reports, but restricts creation, updates, and deletion.
     * @path /reports/{reportId}
     * @allow (get, list) Any user can read any report.
     * @deny (create) Any user cannot create a report directly.
     * @deny (update) Any user cannot update a report directly.
     * @deny (delete) Any user cannot delete a report directly.
     * @principle Enforces public read access with no write access through rules. Writes should be handled by backend.
     */
    match /reports/{reportId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows anyone to read sources. Creation, updates, and deletion are not allowed through rules.
     * @path /sources/{sourceId}
     * @allow (get, list) Any user can read any source.
     * @deny (create) Any user cannot create a source directly.
     * @deny (update) Any user cannot update a source directly.
     * @deny (delete) Any user cannot delete a source directly.
     * @principle Allows public read access with no write access.
     */
    match /sources/{sourceId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows anyone to read categories. Creation, updates, and deletion are not allowed through rules.
     * @path /categories/{categoryId}
     * @allow (get, list) Any user can read any category.
     * @deny (create) Any user cannot create a category directly.
     * @deny (update) Any user cannot update a category directly.
     * @deny (delete) Any user cannot delete a category directly.
     * @principle Allows public read access with no write access.
     */
    match /categories/{categoryId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows anyone to read departments. Creation, updates, and deletion are not allowed through rules.
     * @path /departments/{departmentId}
     * @allow (get, list) Any user can read any department.
     * @deny (create) Any user cannot create a department directly.
     * @deny (update) Any user cannot update a department directly.
     * @deny (delete) Any user cannot delete a department directly.
     * @principle Allows public read access with no write access.
     */
    match /departments/{departmentId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }
  }
}