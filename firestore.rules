rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the request is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the request's auth UID matches the provided userId.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Rules for user-owned draft reports.
     * @path /users/{userId}/draft_reports/{reportId}
     * @allow (create) User 'aJuYSdn5M9ajQs8yBA4Wwi6MHGN2' can create a draft report under /users/aJuYSdn5M9ajQs8yBA4Wwi6MHGN2/draft_reports/report123
     * @deny (create) User 'otherUser' cannot create a draft report under /users/aJuYSdn5M9ajQs8yBA4Wwi6MHGN2/draft_reports/report123
     * @principle Enforces document ownership for writes and restricts access to a user's own data tree.
     */
    match /users/{userId}/draft_reports/{reportId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Rules for finalized reports.
     * @path /reports/{reportId}
     * @allow (get, list) Any user can read any report
     * @deny (create) Any user cannot create a report directly
     * @principle Public read access, owner-only writes.  Consider adding a 'members' map if collaborative access is required.
     */
    match /reports/{reportId} {
      allow get, list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Rules for news sources.
     * @path /sources/{sourceId}
     * @allow (get, list) Any user can read any source.
     * @deny (create)  No user can create a source
     * @principle Public read access.
     */
    match /sources/{sourceId} {
      allow get, list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;// TODO:  Determine which user roles can create, update, and delete sources.
    }

    /**
     * @description Rules for report categories.
     * @path /categories/{categoryId}
     * @allow (get, list) Any user can read any category.
     * @deny (create)  No user can create a category
     * @principle Public read access.
     */
    match /categories/{categoryId} {
      allow get, list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;// TODO:  Determine which user roles can create, update, and delete categories.
    }

    /**
     * @description Rules for NHRC departments.
     * @path /departments/{departmentId}
     * @allow (get, list) Any user can read any department.
     * @deny (create)  No user can create a department
     * @principle Public read access.
     */
    match /departments/{departmentId} {
      allow get, list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;// TODO:  Determine which user roles can create, update, and delete departments.
    }
  }
}